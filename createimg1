#!/bin/bash

## Must be run with root (sudo)!

set -x
set -e

VMSIZE=2G

create_img() {
   sudo -u "$SUDO_USER" mkdir -p "/home/$SUDO_USER/grml-debootstraptestbin"

   export DEBUG="true"

   #export KERNEL="linux-image-amd64"

   export FSCK='yes'
   export TIMEZONE='UTC'
   export RM_APTCACHE='no'
   export UPGRADE_SYSTEM='no'
   export FIXED_DISK_IDENTIFIERS='yes'

   export DEBOOTSTRAP=mmdebstrap
   export INITRD_GENERATOR=dracut
   export http_proxy=http://127.0.0.1:3142

   bash -x \
      grml-debootstrap \
         --arch amd64 \
         --filesystem ext4 \
         --force \
         --hostname host \
         --mirror http://HTTPS///deb.debian.org/debian \
         --keep_src_list \
         --password changeme \
         --release bookworm \
         --verbose \
         --vmfile \
         --vmsize "$VMSIZE" \
         --vmefi \
         --packages ./packages \
         --target "/home/$SUDO_USER/grml-debootstraptestbin/test.img"

   chown --recursive user:user /home/$SUDO_USER/grml-debootstraptestbin
}

create_img
